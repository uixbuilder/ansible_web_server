---
- name: Add SSH key to DigitalOcean if not exists
  community.digitalocean.digital_ocean_sshkey:
    oauth_token: "{{ do_api_token }}"
    name: "{{ ssh_key_name }}"
    ssh_pub_key: "{{ ssh_public_key }}"
    validate_certs: false
    state: present
  register: provision_public_key

- name: Provision droplet
  community.digitalocean.digital_ocean_droplet:
    oauth_token: "{{ do_api_token }}"
    name: "{{ droplet_name }}"
    size: s-1vcpu-512mb-10gb
    region: fra1
    image: ubuntu-22-04-x64
    unique_name: true
    ssh_keys:
      - "{{ provision_public_key.data.ssh_key.fingerprint }}"
    monitoring: true
    tags: ["ansible"]
    state: active
  register: provision_droplet
  notify: Add new droplet to inventory

- name: Wait for SSH to become available
  ansible.builtin.wait_for:
    host: "{{ (provision_droplet.data.droplet.networks.v4 | selectattr('type', 'eq', 'public') | map(attribute='ip_address') | first) }}"
    port: 22
    delay: 2
    timeout: 30
    state: started
